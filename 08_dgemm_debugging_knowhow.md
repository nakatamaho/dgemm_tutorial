# DGEMM デバッグガイド - 最小構成と検証テクニック

このガイドでは、C++プログラムでBLAS dgemmと自作実装を比較検証する際の「デバッグ最小構成」を紹介します。

## デバッグの基本ポイント

1. **Octave/Matlab形式で出力**: 計算結果を確認するため、行列をOctave/Matlab互換フォーマットで標準出力に表示
2. **番兵値の活用**: 行列外アクセスを検知するため、未使用領域を番兵値（-1000.0）で埋める
3. **小さな整数値の使用**: 0〜9までの整数乱数を用いて、ターミナルで目視確認しやすいデータに限定
4. **小さな行列サイズ**: 行列サイズを意図的に4×4に固定し、領域外アクセスやleading-dimension周りのバグを可視化

## デバッグしやすい出力方法のメリット

* 小さな整数値を使うことで、画面表示が見やすくなる
* 整数演算になるため、正解と誤差ゼロで比較できる
* Octaveにコピペして正解と比較できる

## 準備

### BLASとOctaveのインストール

Debian/Ubuntu系の場合:

```bash
$ sudo apt update
$ sudo apt install libopenblas-dev octave
```

* **libopenblas-dev**: BLAS (Basic Linear Algebra Subprograms) のライブラリを使うための開発用パッケージ
* **octave**: MATLAB互換の数値計算ソフトウェア

## テストプログラムの実行

```bash
$ cd 08
$ make
$ ./dgemm_debug_print
```

実行例:

```
A = [
        7     4     1     7;
        2     9     8     6;
       -1     9    -4    -2;
       -3    -7    -4    -6
];

B = [
       -9     9     1    -8;
        2    -6     0     4;
        2     8    -2     4;
       -7     0     3     3
];

C = [
        3     6     5     7;
       -7    -7     0    -1;
        4     9    -7     8;
        7     0    -7    -2
];

alpha = -5;
beta  = -3;

C_blas = [
      501  -253  -145    54;
      151  -119   -20  -347;
     -177   448    16  -134;
     -256    85    86   196
];

C = alpha * A * B + beta * C;
C_blas - C
```

## Octaveでの検証

出力結果をそのままOctaveにコピー＆ペーストして検証できます:

```bash
$ ./dgemm_debug_print | octave
ans =

   0   0   0   0
   0   0   0   0
   0   0   0   0
   0   0   0   0
```

**全て0の行列**が表示されれば、実装したDGEMMがBLASの計算結果と一致していることを意味します。

## 効果的な出力設計のポイント

1. **小さな整数値の使用**
   - 目視確認がしやすい（数桁に収まる）
   - 計算結果が必ず整数になるため、浮動小数点による誤差が発生せず、正確に比較可能
   - 「バグなしならば誤差ゼロ」と「誤差ゼロならばバグなし」の両方が成立しやすい

2. **Octave互換フォーマットの採用**
   - `A = [...]; B = [...]; C = [...];` の構文を使用
   - Octaveに直接コピペして検証できる
   - クロスチェックが容易

3. **注意点**
   - オーバーフローの可能性
   - 非常に低い確率ですが、バグがあっても偶然正解と一致する可能性がある

## まとめ

- **検証方法**: 同一の行列・スカラーを使って、実装したDGEMMとBLAS/Octaveでの結果を比較する
- **使用データ**: 小さめのランダムな整数値を使うことで視認性と検証精度が向上
- **出力形式**: Octave互換フォーマットで出力し、直接Octaveで検証可能
- **バグ検出**: `C_blas - C` がゼロ行列なら実装が正しい可能性が高い

このアプローチにより、DGEMMの実装が正しく動作しているかを簡単かつ効率的に検証できます。

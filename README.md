# DGEMM高速化チュートリアル
**スクラッチから挑戦：Ryzen Threadripper 3970X で 1 TFLOPS への道**

## 📖 DGEMMとは？

**DGEMM** = **行列の掛け算を超高速で実行する技術**

```
C = A × B （行列の掛け算）
```

- **D**: Double precision（倍精度浮動小数点）
- **GE**: GEneral（一般的な行列）  
- **MM**: Matrix Multiplication（行列の掛け算）

### なぜ行列の掛け算が重要？
| 分野 | 使用例 | DGEMMの役割 |
|------|--------|------------|
| **AI・機械学習** | ニューラルネットワーク | 重みの計算・学習 |
| **科学計算** | 気象予測・分子シミュレーション | 連立方程式の求解 |
| **画像・映像** | 3Dグラフィックス・画像認識 | 座標変換・フィルタ処理 |
| **金融・暗号** | リスク計算・RSA暗号 | 大規模数値計算 |

**つまり**: 現代のあらゆるコンピュータ処理の**心臓部**がDGEMM

---

## 🎯 このチュートリアルについて

**DGEMM**（Double precision General Matrix Multiplication）をRyzen Threadripper 3970X上で**完全にスクラッチから実装**し、**ナイーブ実装から1000倍高速化**を実現する実践的チュートリアルです。

### 🔨 なぜスクラッチ実装か？
**「OpenBLAS使えばいいじゃん」への回答**

| スクラッチ実装 | 既存ライブラリ使用 |
|---------------|------------------|
| ✅ **完全理解**: 内部動作を100%把握 | ❌ ブラックボックス |
| ✅ **学習効果**: HPCスキルが身につく | ❌ ただの関数呼び出し |
| ✅ **カスタマイズ**: 特殊要件に対応可能 | ❌ 汎用設計で制約 |
| ✅ **デバッグ力**: 問題の根本特定可能 | ❌ ライブラリバグは対処不可 |
| ✅ **応用力**: 他の最適化問題に転用 | ❌ DGEMM以外に活かせない |

### なぜ3970X特化か？
**実装は特化、技術は汎用**という戦略です。

| 項目 | 3970X特化部分 | 汎用技術部分 |
|------|-------------|-------------|
| **ブロック化** | L3=128MB用パラメータ | キャッシュ階層活用の原理 |
| **パネル化** | Zen2固有メモリ配置 | データ再利用の戦略 |
| **SIMD** | AVX2(8-way)実装 | ベクトル並列の考え方 |
| **並列化** | 32コア/NUMA対応 | マルチコア活用の基本 |

現代CPU（Intel、AMD、ARM）共通の**基本原理は同じ**、異なるのは**具体的パラメータ**のみ。3970Xで学んだ技術は他CPUにも応用可能です。

---

## 📅 4回完結学習プログラム（90分×4回）

### 📋 基本方針
- **各回90分**: 理論理解 + 実装方針 + 実践演習
- **段階的習得**: 基礎→最適化→並列→統合
- **確実な成果**: 無理なく1 TFLOPS超達成

| 回 | テーマ | 時間 | 学習目標 | 達成性能 |
|:---:|------|:---:|----------|:--------:|
| **1** | 基礎理解 | 90分 | DGEMM本質理解+環境構築 | 0.01 TFLOPS |
| **2** | メモリ最適化 | 90分 | キャッシュブロック化習得 | 0.1 TFLOPS |
| **3** | SIMD最適化 | 90分 | AVX2活用技術習得 | 0.4 TFLOPS |
| **4** | 並列統合 | 90分 | 32コア活用+最終統合 | **1.2 TFLOPS** |

---

## 💻 ターゲット環境

### ✅ 推奨環境（動作保証）
- **CPU**: Ryzen Threadripper 3970X (32コア/64スレッド)
- **アーキテクチャ**: Zen2、AVX2対応
- **OS**: Linux (Ubuntu推奨)
- **コンパイラ**: GCC 9.0以上

### ⚠️ 重要な注意
- **3970X専用**: 他CPU（Intel等）では性能が出ない可能性
- **AVX512非対応**: 3970XはAVX2のみ対応
- **NUMA構成**: 32コアの効率的活用には注意が必要

---

## 📚 回別詳細プログラム

### 第1回：基礎理解（90分）
**🎯 目標**: DGEMM本質理解 + 基本実装

| 時間 | 内容 | 現在章 | 活動 | 成果物 |
|------|------|:------:|------|--------|
| 0-20分 | DGEMM基礎と重要性 | Ch.1 | 講義 | 動機形成 |
| 20-40分 | 3970Xアーキテクチャ | Ch.2 | 講義+実習 | 環境理解 |
| 40-70分 | ナイーブ実装 | Ch.6 | 実装+測定 | 動作する基本版 |
| 70-90分 | 性能測定+問題発見 | Ch.7 | 分析 | ボトルネック特定 |

**📈 到達目標**: 0.01 TFLOPS（基準値確立）

### 第2回：メモリ最適化（90分）
**🎯 目標**: キャッシュ効率最大化

| 時間 | 内容 | 現在章 | 活動 | 成果物 |
|------|------|:------:|------|--------|
| 0-25分 | メモリ階層理論 | Ch.9 | 講義+図解 | キャッシュ理解 |
| 25-50分 | ブロッキング数理 | Ch.10 | 理論+設計 | 最適ブロックサイズ |
| 50-80分 | ブロック化実装 | Ch.15 | 実装+測定 | 10倍高速化版 |
| 80-90分 | デバッグ技法 | Ch.8 | 実践 | 問題解決力 |

**📈 到達目標**: 0.1 TFLOPS（10倍高速化達成）

### 第3回：SIMD最適化（90分）
**🎯 目標**: AVX2活用による並列処理

| 時間 | 内容 | 現在章 | 活動 | 成果物 |
|------|------|:------:|------|--------|
| 0-30分 | マイクロカーネル設計 | Ch.12 | 講義+設計 | カーネル戦略 |
| 30-50分 | 4x4カーネル基礎 | Ch.13 | 実装 | レジスタ効率化 |
| 50-80分 | AVX2マイクロカーネル | Ch.16 | 実装+最適化 | SIMD活用版 |
| 80-90分 | カーネル性能比較 | Ch.17 | 測定+分析 | 最適カーネル選択 |

**📈 到達目標**: 0.4 TFLOPS（40倍高速化達成）

### 第4回：並列統合（90分）
**🎯 目標**: 32コア活用+最終統合

| 時間 | 内容 | 現在章 | 活動 | 成果物 |
|------|------|:------:|------|--------|
| 0-20分 | データパネル化 | Ch.14 | 理論+実装 | メモリ効率化 |
| 20-50分 | OpenMP並列化 | Ch.18 | 実装+チューニング | マルチコア版 |
| 50-80分 | 統合最適化 | 新規 | 全技術統合 | **1 TFLOPS超版** |
| 80-90分 | まとめ+継続学習 | Ch.19-20 | 振り返り | 発展計画 |

**📈 到達目標**: **1.2 TFLOPS（120倍高速化達成）**

---

## 🚀 達成可能な性能目標

### 📊 回別性能向上（3970X実測値）
| 回 | 実装内容 | 性能 | 累積向上率 | 技術習得 |
|:---:|----------|:----:|:---------:|----------|
| 1 | ナイーブ実装 | 0.01 TFLOPS | 1倍 | 基礎理解 |
| 2 | キャッシュブロック化 | 0.1 TFLOPS | 10倍 | メモリ最適化 |
| 3 | AVX2マイクロカーネル | 0.4 TFLOPS | 40倍 | SIMD活用 |
| **4** | **32コア並列統合** | **1.2 TFLOPS** | **120倍** | **完全統合** |

### 🎯 最終目標
**Ryzen Threadripper 3970Xで1 TFLOPS超えの行列積実現**

---

## 💡 習得できるスキル

### 🌍 汎用技術としての価値
**3970X実装だが、現代CPU共通の重要技術を習得**
- **キャッシュブロック化**: Intel/AMD/ARM全てに応用可能な基本原理
- **データパネル化**: 階層メモリ構造を持つ全CPUで有効
- **SIMD最適化**: AVX/NEON等、ベクトル命令の共通思想
- **並列化戦略**: マルチコア時代の必須スキル
- **メモリ最適化**: 現代コンピュータアーキテクチャの核心

### 🔨 スクラッチ実装ならではのスキル
- **🧠 根本理解**: なぜ速いのか、なぜ遅いのかを完全把握
- **⚙️ 実装力**: ゼロからの高性能コード作成能力
- **🔍 問題解決力**: ボトルネック特定とデバッグ技術
- **📈 性能分析**: プロファイリング・最適化サイクル
- **🎯 応用力**: 他の計算問題への転用スキル

---

## 🗂️ コンテンツ構成

### 🔥 メイン学習（各回90分）
実用的な1 TFLOPS達成に必要な核心技術

### 🚀 発展学習（自習推奨）
| 章 | タイトル | 内容 | 位置づけ |
|:---:|----------|------|----------|
| 3 | プレDGEMM | 実装準備 | 基礎補強 |
| 4-5 | メモリ配置詳細 | データ構造設計 | 理論深化 |
| 11 | ランク1更新 | 高度なアルゴリズム | 応用技術 |

### 📖 参考資料
- Chapter 20: 参考文献・継続学習ガイド
- 性能測定データ・ベンチマーク結果
- 他CPU移植のためのパラメータ集

---

## 📞 コミュニティ・貢献

### 🤝 貢献方法
- **他CPU移植**: 学習した汎用技術をIntel/ARM等に適用
- **パラメータ共有**: 異なるCPU向けの最適値データベース
- **実装改善提案**: より効率的なアルゴリズム発見
- **汎用化**: 3970X特化から汎用ライブラリへの発展

### 🐛 トラブルシューティング
- **GitHub Issues**: 実装上の質問・バグレポート
- **実測データ共有**: 性能結果の比較・検証
- **環境情報**: 動作確認済み環境の報告

---

## ⚡ 学習の始め方

### 1. 覚悟を決める
```bash
# 「ライブラリに頼らない」決意
echo "4回で1 TFLOPSを実現する"
```

### 2. 環境確認
```bash
# CPU確認（3970Xであることを確認）
lscpu | grep "Model name"
# AVX2対応確認  
cat /proc/cpuinfo | grep avx2
# コア数確認
nproc
```

### 3. 学習スケジュール設定
- **第1回**: 基礎理解+環境構築
- **第2回**: キャッシュ最適化
- **第3回**: SIMD活用
- **第4回**: 並列統合

### 4. 実装開始
```bash
git clone [このリポジトリ]
cd session1_basics/
# まずは最もシンプルな3重ループから
make naive_dgemm
./naive_dgemm
# 4回の旅の始まり...
```

---

**🔨 ライブラリに頼らず、自分の手で1 TFLOPSを掴み取ろう！**

*「なぜ速いのか」を理解するまでが、本当の高速化。*  
*3970Xで学んだ技術は、現代CPU全てに通じる財産となる。*
